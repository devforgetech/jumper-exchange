name: PR Checks
on:
  pull_request:
    types: [opened, synchronize, reopened]
permissions:
  pull-requests: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  lint-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Configure git
        run: |
          git config --global user.name github-actions[bot]
          git config --global user.email 41898282+github-actions[bot]@users.noreply.github.com
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install
      - name: Lint Staged
        run: |
          pnpm lint-staged --diff="${PR_TARGET_SHA}...${PR_SOURCE_SHA}"
        env:
          PR_TARGET_SHA: ${{ github.event.pull_request.base.sha }}
          PR_SOURCE_SHA: ${{ github.event.pull_request.head.sha }}
      - name: Check for uncommitted changes after lint-staged
        run: |
          if ! git diff --staged --quiet --exit-code; then
            echo "## ðŸŽ¨ The following files missed linting:" > DIFF.txt
            echo "" >> DIFF.txt
            echo '```' >> DIFF.txt
            git diff --stat --staged | head -n -1 >> DIFF.txt
            echo '```' >> DIFF.txt
            echo "" >> DIFF.txt
            echo "To fix this issue, use \`pnpm lint-staged --diff=\"${SOURCE_NAME}...${BRANCH_NAME}\"\` to lint changed files." >> DIFF.txt
            echo "" >> DIFF.txt
            echo "ðŸš§ Your commit hooks might be missing ðŸš§" >> DIFF.txt
            exit 1
          fi
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
          SOURCE_NAME: ${{ github.base_ref || 'base-branch' }}
      - name: Comment on PR in case of failure
        if: failure()
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: "Lint-staged"
          path: DIFF.txt
      - name: Hide the Comment in case of success
        if: success()
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: "Lint-staged"
          hide: true
          hide_classify: "RESOLVED"
